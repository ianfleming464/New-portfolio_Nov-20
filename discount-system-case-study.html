<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Case Study · Discount Coordination Engine — Ian Fleming</title>

  <link rel="short icon" href="img/favicon-32x32.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>

  <!-- Simple top bar back link -->
  <header class="header" style="border-bottom:1px solid rgba(0,0,0,.06)">
    <div class="logo"><img src="img/Ian Fleming logo.png" alt=""/></div>
    <nav class="nav-inline">
      <a class="nav-inline__link" href="index.html#work"><i class="fas fa-arrow-left"></i> Back to My Work</a>
    </nav>
  </header>

  <!-- HERO -->
  <section class="case-hero">
    <div class="container">
      <h1 class="case-title">Custom Cart Discount Coordination Engine</h1>
      <p class="case-subtitle">Bridging Shopify’s cart/checkout logic to show trustworthy, combined discounts in the cart UI.</p>

      <div class="case-meta">
        <span class="pill">Role: Lead Developer</span>
        <span class="pill">Deployed to 8+ stores</span>
        <span class="pill">Stack: JS · Liquid · Rebuy · DOM</span>
      </div>
    </div>
  </section>

  <!-- OVERVIEW GRID -->
  <section class="case-grid container">
    <div class="case-main">
      <h2>Summary</h2>
      <p>
        Shopify applies <em>automatic</em> discounts at checkout and allows us to handle <em>manual</em> codes at the cart layer. The two don’t natively combine in the cart, and the line item UI does not natively update to reflect the discount, leading to confusing subtotals and lost trust. I built a modular cart-layer system that detects both, allocates discounts proportionally, renders clear per-line price changes, and derives a truthful subtotal so the cart matches checkout expectations.
      </p>

      <div class="callout-note">
        <i class="fas fa-lock"></i>
        Client code is private. This case study documents architecture, approach, and redacted UI behaviour.
      </div>

      <h3>The Challenge</h3>
        <ul>
          <li>Cart shows €100, checkout shows €85 with no explanation of the difference</li>
          <li>Cart renders a message saying "Discount applied in checkout", but perhaps there is a clearer way to show this?</li>
          <li>No visual feedback when quantity changes affect line item pricing</li>
          <li>Automatic discounts completely invisible until checkout (again, "...applied in checkout")</li>
          <li>Manual discount codes don't coordinate with automatic promotions</li>
          <li>High support volume from pricing confusion and lost customer trust</li>
          <li>Shopify splits/merges identical line items, breaking naïve grouping logic.</li>
        </ul>

      <h3>Solution · Built in Stages</h3>
      <ol>
        <li><strong>Callbacks for line items</strong> – dynamic UI based on quantity/changes. Not native behaviour in all Shopify themes</li>
        <li><strong>Free gift handler</strong> – reads MOV/code/gift from Admin; adds/removes safely and dynamically depending on cart state</li>
        <li><strong>Manual discount code UI</strong> adds – compare-at + sale classes; transparent pricing; saves original state for ease of code removal</li>
        <li><strong>Proportional allocation</strong> – fixed / % discounts spread across line items, so subtotal is accurate.</li>
        <li><strong>URL discount sync</strong> – detects Shopify’s <code>discount_code</code> cookie; applies same UI updates.</li>
        <li><strong>3-for-2 handler</strong> – cheapest eligible item goes to zero; visuals + math stay in sync. UI updates working in conjunction with native "Buy X Get Y" Shopify discount</li>
        <li><strong>Auto-discount detection</strong> – listens for platform signals; mirrors expected checkout discounting in cart.</li>
        <li><strong>Derived subtotal for combo scenarios</strong> – sums effective per-line sale prices; overwrites displayed subtotal with guardrails.</li>
        <li><strong>Combination logic</strong> – manual + auto together with coherent UI and totals.</li>
        <li><strong>Split/merge resilience</strong> – defensive regrouping; fails-safe to native display when needed.</li>
        <li><strong>Event Manager → Coordinator (coming soon)</strong> – migrating to a single orchestrator (queue + debounce) for clean sequencing.</li>
        <li><strong>State preservation (coming soon)</strong> – quick, safe reversion when codes/conditions change.</li>
      </ol>

     
      <h3>Technical Challenges</h3>
      <p>Ensuring proportional discount allocation across mixed cart items (percentage vs. fixed amounts) while maintaining subtotal accuracy required custom mathematical distribution algorithms that consistently matched Shopify's backend calculations. Some markets required different currency formatting while maintaining unified discount logic.</p>
      <p>Getting the cart line item UI to accurately reflect combination situations - for example, a URL-based discount is applied by Shopify at checkout level, then manually entered codes are cart level (so essentially ignored by Shopify's frontend). Getting the line item discounting to accurately calculate the correct full discount, update the subtotal - which natively ONLY shows the Shopify-applied disocounting (so the checkout-level, not checkout+cart level) and having everything reliably accurate into the checkout.</p>
      <p>Comprehensive debugging was essential given the system's complexity across multiple platforms and discount combinations. Each module includes extensive debug logging that can be enabled via browser console commands (<code>window.CartCallbacks.debug(true)</code>), providing real-time visibility into state changes, allocation calculations, and UI updates. This proved invaluable for troubleshooting edge cases and performance optimization across different international deployments.</p>

      <h3>Architecture (high level)</h3>
      <ul class="bullets-tight">
        <li><code>callbacks/</code> – DOM mutations for price/badge/subtotal.</li>
        <li><code>handlers/</code> – free gifts, 3-for-2, code presence, auto-discount signals.</li>
        <li><code>utils/</code> – logging, cookies, debouncing, selectors, currency.</li>
        <li><code>eventManager</code> → <code>discountCoordinator</code> – orchestrate updates deterministically.</li>
      </ul>
        <p>The upcoming DiscountCoordinator will replace the current event manager's broadcast approach with intelligent orchestration. Instead of multiple handlers reacting simultaneously to cart events, the Coordinator will analyze discount state first, then decide which handlers should run, in what order, and with what data. This prevents conflicts and race conditions while enabling more sophisticated discount combinations and cleaner debugging workflows.</p>

      <h3>Impact</h3>
      <ul>
        <li><strong>Improved Trust:</strong> Marketing links show correct prices pre-checkout</li>
        <li><strong>International Deployment </strong>across multiple storefronts; configurable per region.</li>
        <li><strong>Operational Efficiency:</strong> Reduced cart-related support tickets for customer service team, thanks to clear, truthful cart totals</li>
        <li><strong>Marketing Enablement:</strong> Enabled complex promotional campaigns</li>
        <li><strong>Customer Experience:</strong> Maintained customer trust through consistent cart-to-checkout pricing across international markets</li>
      </ul>

      <h3>Key Technical Learning</h3>
        <p>Sometimes the best engineering solution works around platform constraints rather than fighting them - building coordination layers often delivers better results than trying to force incompatible systems to communicate natively.</p>

      <h3>What I’ll Do Next</h3>
      <ul>
        <li>Finish Coordinator refactor; extract allocation/formatting into reusable utils.</li>
        <li>Add configurable selectors so it’s Rebuy-aware, not Rebuy-locked.</li>
        <li>Companion Shopify Functions to enforce rules at checkout where needed.</li>
      </ul>

      <div class="project-links" style="margin-top:1.25rem">
        <a href="https://github.com/yourusername/discount-system-docs" class="btn">Technical Docs</a>
        <a href="files/Ian Fleming Resume 2025.pdf" class="btn btn--ghost" target="_blank">Download Resume</a>
        <a href="index.html#work" class="btn btn--ghost">Back to Work</a>
      </div>
    </div>

    <!-- SIDE META -->
    <aside class="case-side">
      <div class="side-card">
        <h4>Role & Scope</h4>
        <ul class="bullets-tight">
          <li>Lead developer</li>
          <li>Frontend JS + cart UX</li>
          <li>Rebuy integration</li>
          <li>Theme/Liquid work</li>
        </ul>
      </div>

      <div class="side-card">
        <h4>Stack</h4>
        <ul class="bullets-tight">
          <li>JavaScript (ES6+)</li>
          <li>Liquid · DOM APIs</li>
          <li>Rebuy Smart Cart</li>
          <li>Metafields, cookies</li>
        </ul>
      </div>

      <div class="side-card">
        <h4>Constraints</h4>
        <ul class="small">
          <li><strong>Discount Detection:</strong> Data accessibility varies unpredictably between Shopify and Rebuy APIs depending on discount type and application method</li>
          <li><strong>Mathematical Precision:</strong> Rounding conflicts between cart-total and item-level allocation occasionally create 1-cent discrepancies in large carts</li>
          <li><strong>Platform Dependencies:</strong> DOM selector fragility means third-party updates can break functionality without warning</li>
          <li><strong>Race Conditions:</strong> Timing coordination required between multiple platform update cycles</li>
          <li><strong>International Complexity:</strong> Currency formatting, browser compatibility, and general different theme setups across markets</li>
          <li><strong>Line Item Behaviour:</strong> Shopify's unpredictable split/merge logic disrupts grouping assumptions</li>
        </ul>
        <p class="small">System designed to fail-safe to native behaviour when constraints create conflicts; true discount enforcement belongs at checkout level.</p>
      </div>
    </aside>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <a href="mailto:ianflemingdeveloper@gmail.com" class="footer__link">ianflemingdeveloper@gmail.com</a>
    <ul class="social-list">
      <li class="social-list__item"><a class="social-list__link" href="https://github.com/ianfleming464/" target="_blank"><i class="fab fa-github"></i></a></li>
      <li class="social-list__item"><a class="social-list__link" href="https://www.linkedin.com/in/i-fleming/" target="_blank"><i class="fab fa-linkedin"></i></a></li>
    </ul>
  </footer>

</body>
</html>
